import test from "ava"
import {RustModule} from "../../utils/rustLoader"
import {mkOrdersParser} from "./ordersParser"
import {ScriptCredsV1} from "../scripts"
import {QuickblueTx} from "../../quickblue/models"
import {JSONBI} from "../../utils/json"

test.before(async () => {
  await RustModule.load(true)
})

const sampleResponse = `
[
  {"blockHash":"d1fb68cf8aa8447cda296dff9a878ce08d57c7d3d59b9b7b66b4e73699bb437d","blockIndex":12,"globalIndex":4317479,"hash":"65c30f004a1988b65d3e86eff6e445e7bc7eea797a7b73ea3ac0f02207b7add9","inputs":[{"out":{"ref":"15cee802409fa473ec4474040bf849b304425b2c304cbd7c3a8474fe56ae4368:2","blockHash":"d1fb68cf8aa8447cda296dff9a878ce08d57c7d3d59b9b7b66b4e73699bb437d","txHash":"15cee802409fa473ec4474040bf849b304425b2c304cbd7c3a8474fe56ae4368","index":2,"globalIndex":10615623,"addr":"addr_test1qrmzenza7gnsk3zsu40rnwmqes93nmmynzkzsr8g2j3a4fzvqenn455uh4r4e740drhycwlssxgnam4tjwf7uqfta4xqjhwx2c","rawAddr":"00f62ccc5df2270b4450e55e39bb60cc0b19ef6498ac280ce854a3daa44c06673ad29cbd475cfaaf68ee4c3bf081913eeeab9393ee012bed4c","paymentCred":"f62ccc5df2270b4450e55e39bb60cc0b19ef6498ac280ce854a3daa4","value":[{"policyId":"","name":"","quantity":311339128,"jsQuantity":"311339128"}],"dataHash":null,"data":null,"dataBin":null,"spentByTxHash":"65c30f004a1988b65d3e86eff6e445e7bc7eea797a7b73ea3ac0f02207b7add9"},"redeemer":null},{"out":{"ref":"15cee802409fa473ec4474040bf849b304425b2c304cbd7c3a8474fe56ae4368:1","blockHash":"d1fb68cf8aa8447cda296dff9a878ce08d57c7d3d59b9b7b66b4e73699bb437d","txHash":"15cee802409fa473ec4474040bf849b304425b2c304cbd7c3a8474fe56ae4368","index":1,"globalIndex":10615622,"addr":"addr_test1qrmzenza7gnsk3zsu40rnwmqes93nmmynzkzsr8g2j3a4fzvqenn455uh4r4e740drhycwlssxgnam4tjwf7uqfta4xqjhwx2c","rawAddr":"00f62ccc5df2270b4450e55e39bb60cc0b19ef6498ac280ce854a3daa44c06673ad29cbd475cfaaf68ee4c3bf081913eeeab9393ee012bed4c","paymentCred":"f62ccc5df2270b4450e55e39bb60cc0b19ef6498ac280ce854a3daa4","value":[{"policyId":"","name":"","quantity":3206826,"jsQuantity":"3206826"},{"policyId":"c3b39f2855f1c15c1d773f5cc51fc4c9987af269435fcbc6fe452cc5","name":"cNETAt_ADAt_lp","quantity":8219055,"jsQuantity":"8219055"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"cNETAt","quantity":984197286,"jsQuantity":"984197286"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"WMTt","quantity":105090936730,"jsQuantity":"105090936730"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"VYFIt","quantity":461666546,"jsQuantity":"461666546"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"MELDt","quantity":1865310954,"jsQuantity":"1865310954"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"HOSKYt","quantity":2120721697,"jsQuantity":"2120721697"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"GEROt","quantity":983244432,"jsQuantity":"983244432"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"GENSt","quantity":3990615731,"jsQuantity":"3990615731"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"C3t","quantity":3990000000,"jsQuantity":"3990000000"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"AADAt","quantity":1373840518,"jsQuantity":"1373840518"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"ergoTestTokenNFT","quantity":1000000,"jsQuantity":"1000000"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"ergoTestTokenLP","quantity":1000010,"jsQuantity":"1000010"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"ergoTestTokenB","quantity":921822013,"jsQuantity":"921822013"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"ergoTestTokenA","quantity":651648821,"jsQuantity":"651648821"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"789ergoTestTokenLP789","quantity":19354820,"jsQuantity":"19354820"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"321ergoTestTokenLP321","quantity":84052980,"jsQuantity":"84052980"},{"policyId":"2493a4a9842d3d42f0aafd6a63afd7b13477f2524816e353f3b98378","name":"ergoTestTokenA","quantity":10,"jsQuantity":"10"}],"dataHash":null,"data":null,"dataBin":null,"spentByTxHash":"65c30f004a1988b65d3e86eff6e445e7bc7eea797a7b73ea3ac0f02207b7add9"},"redeemer":null}],"outputs":[{"ref":"65c30f004a1988b65d3e86eff6e445e7bc7eea797a7b73ea3ac0f02207b7add9:2","blockHash":"d1fb68cf8aa8447cda296dff9a878ce08d57c7d3d59b9b7b66b4e73699bb437d","txHash":"65c30f004a1988b65d3e86eff6e445e7bc7eea797a7b73ea3ac0f02207b7add9","index":2,"globalIndex":10615835,"addr":"addr_test1qrmzenza7gnsk3zsu40rnwmqes93nmmynzkzsr8g2j3a4fzvqenn455uh4r4e740drhycwlssxgnam4tjwf7uqfta4xqjhwx2c","rawAddr":"00f62ccc5df2270b4450e55e39bb60cc0b19ef6498ac280ce854a3daa44c06673ad29cbd475cfaaf68ee4c3bf081913eeeab9393ee012bed4c","paymentCred":"f62ccc5df2270b4450e55e39bb60cc0b19ef6498ac280ce854a3daa4","value":[{"policyId":"","name":"","quantity":306403837,"jsQuantity":"306403837"}],"dataHash":null,"data":null,"dataBin":null,"spentByTxHash":null},{"ref":"65c30f004a1988b65d3e86eff6e445e7bc7eea797a7b73ea3ac0f02207b7add9:1","blockHash":"d1fb68cf8aa8447cda296dff9a878ce08d57c7d3d59b9b7b66b4e73699bb437d","txHash":"65c30f004a1988b65d3e86eff6e445e7bc7eea797a7b73ea3ac0f02207b7add9","index":1,"globalIndex":10615834,"addr":"addr_test1qrmzenza7gnsk3zsu40rnwmqes93nmmynzkzsr8g2j3a4fzvqenn455uh4r4e740drhycwlssxgnam4tjwf7uqfta4xqjhwx2c","rawAddr":"00f62ccc5df2270b4450e55e39bb60cc0b19ef6498ac280ce854a3daa44c06673ad29cbd475cfaaf68ee4c3bf081913eeeab9393ee012bed4c","paymentCred":"f62ccc5df2270b4450e55e39bb60cc0b19ef6498ac280ce854a3daa4","value":[{"policyId":"","name":"","quantity":3206826,"jsQuantity":"3206826"},{"policyId":"c3b39f2855f1c15c1d773f5cc51fc4c9987af269435fcbc6fe452cc5","name":"cNETAt_ADAt_lp","quantity":8219055,"jsQuantity":"8219055"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"cNETAt","quantity":984197286,"jsQuantity":"984197286"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"WMTt","quantity":105090936730,"jsQuantity":"105090936730"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"VYFIt","quantity":461666546,"jsQuantity":"461666546"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"MELDt","quantity":1865310954,"jsQuantity":"1865310954"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"HOSKYt","quantity":2120721697,"jsQuantity":"2120721697"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"GEROt","quantity":983244432,"jsQuantity":"983244432"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"GENSt","quantity":3990615731,"jsQuantity":"3990615731"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"C3t","quantity":3990000000,"jsQuantity":"3990000000"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"AADAt","quantity":1373840518,"jsQuantity":"1373840518"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"ergoTestTokenNFT","quantity":1000000,"jsQuantity":"1000000"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"ergoTestTokenLP","quantity":1000010,"jsQuantity":"1000010"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"ergoTestTokenB","quantity":921822013,"jsQuantity":"921822013"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"ergoTestTokenA","quantity":651648821,"jsQuantity":"651648821"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"789ergoTestTokenLP789","quantity":19354820,"jsQuantity":"19354820"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"321ergoTestTokenLP321","quantity":84052980,"jsQuantity":"84052980"},{"policyId":"2493a4a9842d3d42f0aafd6a63afd7b13477f2524816e353f3b98378","name":"ergoTestTokenA","quantity":10,"jsQuantity":"10"}],"dataHash":null,"data":null,"dataBin":null,"spentByTxHash":null},{"ref":"65c30f004a1988b65d3e86eff6e445e7bc7eea797a7b73ea3ac0f02207b7add9:0","blockHash":"d1fb68cf8aa8447cda296dff9a878ce08d57c7d3d59b9b7b66b4e73699bb437d","txHash":"65c30f004a1988b65d3e86eff6e445e7bc7eea797a7b73ea3ac0f02207b7add9","index":0,"globalIndex":10615833,"addr":"addr_test1wrx2hy06cqkwkc3gr4nddrs30t8z4vvhlsltz2ffhxvu5vg88208n","rawAddr":"70ccab91fac02ceb62281d66d68e117ace2ab197fc3eb12929b999ca31","paymentCred":"ccab91fac02ceb62281d66d68e117ace2ab197fc3eb12929b999ca31","value":[{"policyId":"","name":"","quantity":4744798,"jsQuantity":"4744798"}],"dataHash":"4bbcd53786201715a7e64f371cbe1a917ccd37c70ac07a1c6f47b49842d5e2eb","data":{"fields":[{"fields":[{"bytes":""},{"bytes":""}],"constructor":0},{"fields":[{"bytes":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac"},{"bytes":"4d454c4474"}],"constructor":0},{"fields":[{"bytes":"845c337c265b63558b775bbc346585e54914719698429131b3bb838d"},{"bytes":"4d454c44745f414441745f6e6674"}],"constructor":0},{"int":995},{"int":18397825377040433},{"int":10000000000000000},{"bytes":"f62ccc5df2270b4450e55e39bb60cc0b19ef6498ac280ce854a3daa4"},{"fields":[{"bytes":"4c06673ad29cbd475cfaaf68ee4c3bf081913eeeab9393ee012bed4c"}],"constructor":0},{"int":1000000},{"int":1087085}],"constructor":0},"dataBin":"d8799fd8799f4040ffd8799f581cb8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac454d454c4474ffd8799f581c845c337c265b63558b775bbc346585e54914719698429131b3bb838d4e4d454c44745f414441745f6e6674ff1903e31b00415cb9863cf8311b002386f26fc10000581cf62ccc5df2270b4450e55e39bb60cc0b19ef6498ac280ce854a3daa4d8799f581c4c06673ad29cbd475cfaaf68ee4c3bf081913eeeab9393ee012bed4cff1a000f42401a0010966dff","spentByTxHash":null}],"invalidBefore":null,"invalidHereafter":null,"metadata":null,"size":793}
]
`

const txs: QuickblueTx[] = JSONBI.parse(sampleResponse)
test("parse order", async t => {
  const parser = mkOrdersParser(ScriptCredsV1, RustModule.CardanoWasm)
  const orders = txs.flatMap((tx) => tx.outputs.map(out => parser.parseOrder(out))).filter(Boolean)
  t.assert(orders.length !== 0, "Orders are not parsed");
  t.log(orders);
})
